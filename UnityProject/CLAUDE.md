# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview
This is a Unity-based mobile game project called "Gear Fight" (version 5.1.3). The codebase is an exported Unity project with decompiled C# scripts from Assembly-CSharp.

## Project Structure

### Key Directories
- `Scripts/Assembly-CSharp/` - Main game code (decompiled from Assembly-CSharp.dll)
  - `GearGame/` - Core game logic
    - `Gameplay/` - Game mechanics, managers for game state, progress, enemies, allies
    - `Managers/` - Singleton managers for resources, currency, audio, transitions
    - `UI/` - User interface components
    - `Purchasing/` - IAP (In-App Purchase) implementation
    - `Tutorials/` - Tutorial system
    - `Control/` - Game analytics and world settings
  - `Voodoo/` - Third-party SDK integrations (ads, analytics, cross-promotion)
  - `Nakama/` - Multiplayer/backend service integration
  - `Items/` - Item and inventory system
  - `Gameplay/` - Additional gameplay features (blessings system)
  - `UI/Refactor/` - Refactored UI system
  - `SaveSystem/` - Save/load functionality
  - `Features/` - Feature modules
- `Resources/` - Unity resources (likely contains prefabs, sprites, data files)
- `MonoBehaviour/` - Unity MonoBehaviour scripts
- `GameObject/` - GameObject-related scripts

## Architecture Patterns

### Manager Pattern
The codebase heavily uses singleton managers for different game systems:
- `GameStateManager` - Controls overall game state
- `GameProgressManager` - Tracks player progress
- `CurrencyManager` - Handles in-game currency
- `AudioManager` - Audio system management
- `ResourceManager` - Resource loading and management
- `TransitionManager` - Scene transitions
- `PlayerLoadoutManager` - Player equipment/loadout

### Data Classes
Character/enemy data is stored in separate data classes (e.g., `VikingData`, `SpartanData`, `ZombieGruntData`, `RobotMeleeData`)

### Quest System
Implements a quest/achievement system with:
- `QuestManager` - Main quest controller
- `QuestSO` - ScriptableObject for quest data
- `QuestGoalType`, `QuestGoalActionType` - Quest objectives

### Third-Party Integrations
- Voodoo SDK for ads, analytics, and monetization
- Nakama for multiplayer/backend services
- Firebase Crashlytics for crash reporting
- AppHarbr for additional analytics

## Unity-Specific Notes

### Building and Testing
Since this is an exported Unity project without the full Unity project structure:
- Unity Editor is required to properly build the project
- The parent directory should contain the full Unity project structure
- Use Unity Hub to open the project from the ExportedProject directory
- Unity version should match the project's requirements (check ProjectSettings)

### Common Unity Commands
```bash
# Unity projects are typically built through the Unity Editor GUI
# Command-line builds require Unity installed with proper licensing

# For Unity command-line builds (requires Unity installation):
# /Applications/Unity/Hub/Editor/[VERSION]/Unity.app/Contents/MacOS/Unity \
#   -batchmode -quit -projectPath [PROJECT_PATH] \
#   -buildTarget [iOS|Android] \
#   -executeMethod [BUILD_METHOD]
```

### Code Conventions
- Follow Unity's C# naming conventions
- MonoBehaviour scripts typically use PascalCase for public fields
- Coroutines are commonly used for asynchronous operations
- Unity-specific attributes like [SerializeField], [Header], [Space] are used
- Custom attributes for editor functionality (e.g., `ReadOnlyAttribute`, `CustomLabelAttribute`)

## Important Considerations

### Decompiled Code
This appears to be decompiled code from Assembly-CSharp.dll, which means:
- Some code patterns may not be idiomatic (generated by decompiler)
- Meta files (.meta) are Unity's asset tracking files
- Original comments may be missing
- Some constructs may be compiler-generated (e.g., `_003C..._003E` methods)

### Save System
The game uses a custom save system with:
- `GameSaveManager` - Main save/load controller
- `GameProgressSaveManager` - Progress-specific saves
- Cloud save integration (`CloudSaveAccountResolutionPopup`, `CloudSettingsUI`)

### Analytics and Tracking
Multiple analytics systems are integrated:
- Game-specific analytics (`GameAnalyticsEventManager`)
- Voodoo Analytics
- Firebase Crashlytics
- Quest tracking system

### Performance Considerations
- Object pooling is used (`IPooledObject` interface)
- Resource management through `ResourceManager`
- Particle system management (`ResourceManagedParticleSystem`)

## Level System Documentation

### üöÄ Quick Start for Next Session
1. **Check `LEVEL_SYSTEM_DETAILED_DOCS/INDEX.md`** - Complete navigation guide
2. **Read `LEVEL_SYSTEM_DETAILED_DOCS/COMPLETE_DEEP_DIVE_ANALYSIS.md`** - Executive summary
3. **Run `python3 extract_all_levels_to_json.py`** - Generate latest data
4. **Load `gear_fight_complete_levels.json`** - Analyze extracted data
5. **Key Discovery:** 133/134 levels use procedural generation (empty data is intentional!)
6. **Latest Finding:** Complete difficulty curves and formulas extracted

### üìÅ Complete Documentation Index
**‚Üí See `LEVEL_SYSTEM_DETAILED_DOCS/INDEX.md` for full navigation**

### Comprehensive Documentation Files
The following detailed documentation files have been created in `LEVEL_SYSTEM_DETAILED_DOCS/`:

#### üìå Primary References (START HERE)
1. **`COMPLETE_DEEP_DIVE_ANALYSIS.md`** ‚≠ê‚≠ê‚≠ê - **READ THIS FIRST**
   - Executive summary of ALL discoveries
   - Solves the "empty data" mystery
   - Complete system architecture
   - All formulas and calculations
   - Quick reference for everything

2. **`MASTER_REFERENCE.md`** ‚≠ê‚≠ê - **QUICK REFERENCE**
   - Session continuity guide
   - All discoveries summarized
   - Key GUIDs and mappings
   - Troubleshooting guide
   - File locations

3. **`DATA_CONVERSION_COMPLETE_GUIDE.md`** ‚≠ê‚≠ê - **HOW WE EXTRACT DATA**
   - Complete extraction pipeline
   - Unity YAML to JSON conversion
   - GUID resolution methodology
   - Investigation progression timeline
   - Validation methods
   - Code examples with transformations

#### üìä Technical Deep Dives
4. **`DIFFICULTY_CURVES_AND_ANIMATION_CURVES.md`** ‚≠ê‚≠ê - **MATHEMATICAL FORMULAS**
   - Complete analysis of "Linear 50%" difficulty profile
   - All animation curves decoded with exact values
   - Spawn delay, enemy count, and initial delay progressions
   - Enemy type distribution across 5 configurations
   - Level variation probabilities
   - Implementation in FightGenerator

5. **`SPAWN_TIMING_AND_PROCEDURAL_GENERATION.md`** ‚≠ê - **WHY DATA IS "EMPTY"**
   - Why 133/134 levels have empty/default data (intentional design)
   - Spawn timing systems (custom vs procedural)
   - Runtime generation process explained
   - Animation curves for difficulty scaling
   - Enemy selection and ordering algorithms
   - Key insight: Empty `{fileID: 0}` are placeholder slots

6. **`DEEP_DIVE_LEVEL_ECONOMY_DIFFICULTY.md`** - **ECONOMY ANALYSIS**
   - Complete level data patterns (custom vs procedural)
   - Economy system architecture and formulas
   - Difficulty configuration and scaling
   - NIV (Normalized Item Value) system explained
   - Store and gear economy
   - Reward calculations and progression formulas

7. **`COMPLETE_DATA_EXTRACTION_GUIDE.md`** - **GUID MAPPINGS**
   - Complete GUID database (613 assets mapped)
   - Python extraction scripts
   - YAML parsing methods
   - Relationship building
   - Automated pipeline

#### üìö System Architecture Documentation
8. **`LEVEL_DATA_DOCUMENTATION.md`** - High-level overview
   - Level hierarchy (Worlds ‚Üí Chapters ‚Üí Levels ‚Üí Fights ‚Üí Waves)
   - All major systems and interactions
   - File structure reference

9. **`01_CHAPTER_SYSTEM.md`** - Chapter architecture
   - ChaptersProgressionSettings structure
   - ChapterSettings configuration
   - Environment themes and transitions
   - Chapter rewards and unlocks

10. **`02_LEVEL_CONFIGURATION.md`** - Level structure
   - ScriptableLevel properties
   - Fight configuration within levels
   - NIV (Normalized Item Value) system
   - Store and economy integration

11. **`03_FIGHT_GENERATION_SYSTEM.md`** - Fight generation
   - FightGenerator algorithm
   - Enemy spawn patterns and timing
   - Difficulty scaling formulas
   - Custom vs procedural generation

12. **`04_ENEMY_TROOP_SYSTEM.md`** - Enemy catalog
   - All enemy types categorized
   - TroopController architecture
   - Enemy abilities and AI systems
   - Boss and mini-boss mechanics

13. **`REAL_DATA_EXTRACTION_GUIDE.md`** - Initial extraction notes
   - First investigation results
   - Basic YAML structure
   - Initial GUID discoveries

### Actual Game Data Locations
Real level and enemy data found in Unity assets:
- `MonoBehaviour/Chapter*.asset` - Chapter configurations
- `MonoBehaviour/World*Level*.asset` - Individual level data
- `MonoBehaviour/Troop*.asset` - Enemy definitions
- `MonoBehaviour/Gear*.asset` - Equipment items
- `Resources/CombatSimulation*.asset` - Test configurations

### Key Level System Files
- `ScriptableTemplates/ChapterSettings.cs` - Chapter configuration
- `ScriptableTemplates/ChaptersProgressionSettings.cs` - Chapter progression
- `GearGame/Gameplay/ScriptableLevel.cs` - Level definitions
- `GearGame/Control/FightGenerator.cs` - Dynamic fight generation
- `GearGame/Control/ScriptableTroop.cs` - Enemy/troop definitions
- `GearGame/Control/ScriptableDifficultyProfile.cs` - Difficulty curves
- `GearGame/Control/ScriptableGridData.cs` - Puzzle grid layouts
- `GearGame/Gameplay/GameProgressManager.cs` - Progress tracking
- `SaveSystem/SaveData/ScriptableLevelData.cs` - Level save data

### Investigation Status
- ‚úÖ Chapter system fully documented
- ‚úÖ Level configuration analyzed
- ‚úÖ Fight generation system decoded
- ‚úÖ Enemy/troop catalog complete
- ‚úÖ Real data extraction methods identified
- ‚úÖ GUID mapping complete (613 assets mapped)
- ‚úÖ JSON extraction pipeline created (`extract_all_levels_to_json.py`)
- ‚úÖ Spawn timing and procedural generation decoded
- ‚úÖ Difficulty scaling formulas documented (exact curves extracted)
- ‚úÖ NIV (Normalized Item Value) system analyzed
- ‚úÖ Puzzle grid system investigated (60 custom grids found)
- ‚úÖ Structure spawning mechanics understood
- ‚úÖ Gear store generation decoded
- ‚úÖ Complete deep dive analysis documented
- üìã Remaining: Progression unlock chains, Achievement system

## Development Workflow

When modifying this codebase:
1. Ensure changes maintain compatibility with Unity's serialization system
2. Test thoroughly in Unity Editor before building
3. Be cautious with singleton patterns - check for existing instances
4. Follow existing naming conventions and folder structure
5. Update .meta files are handled automatically by Unity - do not modify manually
6. Refer to `LEVEL_DATA_DOCUMENTATION.md` for detailed level system information